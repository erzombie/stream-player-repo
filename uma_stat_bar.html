<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Uma Stat Bar</title>
  <style>
    :root{
      --brown:#3a2514;
      --cream:#f5efe3;
      --divider:#e1d6c6;
      --num:#4a2c0a;
      --shadow:0 12px 24px rgba(0,0,0,.22);
    }
    html,body{margin:0;background:transparent}
    body{font-family:'Roboto',system-ui,-apple-system,'Segoe UI',Arial,sans-serif;color:var(--num)}

    .bar{width:max-content;margin:18px auto;border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
    .row{display:flex}
    .cell{min-width:180px;border-right:1px solid var(--divider)}
    .cell:last-child{border-right:0}

    .label{height:46px;background:var(--brown);display:flex;align-items:center;justify-content:center}
    .label img{height:28px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.25))}

    .valBox{position:relative;height:64px;background:#f8f2e8;display:flex;align-items:center;justify-content:center}
    .val{font-weight:900;font-size:40px;line-height:1}

    /* chevron image inside value box */
    .chev{position:absolute;left:50%;transform:translateX(-50%);pointer-events:none;opacity:.95;filter:drop-shadow(0 8px 18px rgba(0,0,0,.28))}
  </style>
</head>
<body>
  <div class="bar" id="bar">
    <div class="row">
      <div class="cell"><div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_speed.png"   alt="Speed"></div><div class="valBox" id="box_Speed"><div class="val" id="val_Speed">0</div></div></div>
      <div class="cell"><div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_stamina.png" alt="Stamina"></div><div class="valBox" id="box_Stamina"><div class="val" id="val_Stamina">0</div></div></div>
      <div class="cell"><div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_power.png"   alt="Power"></div><div class="valBox" id="box_Power"><div class="val" id="val_Power">0</div></div></div>
      <div class="cell"><div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_guts.png"    alt="Guts"></div><div class="valBox" id="box_Guts"><div class="val" id="val_Guts">0</div></div></div>
      <div class="cell"><div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_wit.png"     alt="Wit"></div><div class="valBox" id="box_Wit"><div class="val" id="val_Wit">0</div></div></div>
    </div>
  </div>

  <script>
    // Assets (same as flying overlay)
    const CHEV_UP   = 'https://erzombie.github.io/stream-player-repo/uma_overlay/uma_pos_chevron.png';
    const CHEV_DOWN = 'https://erzombie.github.io/stream-player-repo/uma_overlay/uma_neg_chevron.png';

    const qs = new URLSearchParams(location.search);
    const theme  = (qs.get('theme')||'up').toLowerCase();
    const waitMs = parseInt(qs.get('waitMs')||'0',10);

    // Prev totals (p*) and Final totals
    const prev = {
      Speed:   parseInt(qs.get('pSpeed')   || '0', 10),
      Stamina: parseInt(qs.get('pStamina') || '0', 10),
      Power:   parseInt(qs.get('pPower')   || '0', 10),
      Guts:    parseInt(qs.get('pGuts')    || '0', 10),
      Wit:     parseInt(qs.get('pWit')     || '0', 10),
    };
    const finalV = {
      Speed:   parseInt(qs.get('speed')   || '0', 10),
      Stamina: parseInt(qs.get('stamina') || '0', 10),
      Power:   parseInt(qs.get('power')   || '0', 10),
      Guts:    parseInt(qs.get('guts')    || '0', 10),
      Wit:     parseInt(qs.get('wit')     || '0', 10),
    };

    // Optional demo: ?demo=1
    if(qs.get('demo')==='1'){
      prev.Speed=0; prev.Stamina=0; prev.Power=0; prev.Guts=0; prev.Wit=0;
      finalV.Speed=108; finalV.Stamina=50; finalV.Power=20; finalV.Guts=-39; finalV.Wit=-20;
    }

    const STAT_KEYS = ['Speed','Stamina','Power','Guts','Wit'];

    // Render previous values
    for(const k of STAT_KEYS){
      document.getElementById('val_'+k).textContent = prev[k];
    }

    // After waitMs, animate only stats that changed
    setTimeout(()=> {
      for(const k of STAT_KEYS){
        const from = prev[k], to = finalV[k];
        if(from === to) continue;
        animateCell(k, from, to, theme);
      }
    }, Math.max(0, waitMs));

    function animateCell(stat, fromVal, toVal, theme){
      const valEl = document.getElementById('val_'+stat);
      const box   = document.getElementById('box_'+stat); // .valBox
      if(!valEl || !box) return;

      // tween number (baseline stays put)
      tweenNumber(valEl, fromVal, toVal, 900);

      // chevron inside number box â€“ compute start/end so the TIP meets the border
      const chev = new Image();
      const isDown = (theme==='down' || toVal < fromVal);
      chev.src = isDown ? CHEV_DOWN : CHEV_UP;
      chev.className = 'chev';
      // choose size that reads well
      const chevH = 38; // px
      chev.style.height = chevH + 'px';
      chev.style.top = '0px';
      box.appendChild(chev);

      const pad = 6;                      // small safety so tip doesn't clip
      const boxH = box.clientHeight;
      const startTop = isDown ? pad : (boxH - chevH - pad);
      const endTop   = isDown ? (boxH - chevH - pad) : pad;

      // Web Animations API: animate top property
      chev.animate(
        [{ top: startTop + 'px', opacity: 0 },
         { top: (startTop + endTop)/2 + 'px', opacity: 1, offset: .25 },
         { top: endTop + 'px', opacity: 0 }],
        { duration: 900, easing: 'cubic-bezier(.2,.9,.2,1)' }
      ).onfinish = ()=> chev.remove();
    }

    function tweenNumber(el, from, to, dur){
      const t0 = performance.now();
      function step(t){
        const p = Math.min(1, (t - t0)/dur);
        const e = 1 - Math.pow(1 - p, 3); // easeOutCubic
        const v = Math.round(from + (to - from)*e);
        el.textContent = v;
        if(p<1) requestAnimationFrame(step); else el.textContent = to;
      }
      requestAnimationFrame(step);
    }
  </script>
</body>
</html>
