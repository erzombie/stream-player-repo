<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Uma Stat Bar Overlay</title>
  <style>
    :root{
      --font:'Roboto',system-ui,-apple-system,'Segoe UI',Arial,sans-serif;
      --num:#4a2c0a;
      --header:#3b2412;
      --cream:#f7efe2;
      --divider:#d8cbb6;
      --fxMs:900ms;         /* chevron duration */
    }

    html,body{margin:0;background:transparent}
    body{font-family:var(--font);color:var(--num)}

    #barWrapper{
      display:flex;gap:0;margin:20px auto;width:max-content;
      border-radius:12px;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.25);
    }

    .stat{
      position:relative;display:flex;flex-direction:column;align-items:center;
      background:var(--cream);border-right:1px solid var(--divider);
      min-width:140px;overflow:hidden; /* clip chevron inside */
    }
    .stat:last-child{border-right:none}

    /* label row (PNG on dark strip) */
    .label{width:100%;height:34px;display:flex;align-items:center;justify-content:center;background:var(--header)}
    .label img{height:100%;width:auto;display:block;filter:drop-shadow(0 1px 3px rgba(0,0,0,.25))}

    /* number row (no slide; only tween digits) */
    .value{
      position:relative;z-index:4;
      font-weight:900;font-size:32px;line-height:1;
      padding:10px 0 12px; text-align:center; min-width:80px;
    }
    .value.pop{animation:valPop .45s ease-out}
    @keyframes valPop{0%{transform:scale(.92)}60%{transform:scale(1.1)}100%{transform:scale(1)}}

    /* FX (chevron) */
    .fx{position:absolute;left:0;right:0;top:34px;bottom:0;pointer-events:none;z-index:3}
    .fx img.chev{
      position:absolute;left:50%;top:50%;
      transform:translate(-50%,-50%);
      height:46px;opacity:.9;filter:drop-shadow(0 8px 18px rgba(0,0,0,.35));
    }
    @keyframes rise{
      0%{transform:translate(-50%,-10%) scale(.92);opacity:0}
      20%{opacity:1}
      80%{transform:translate(-50%,-110%) scale(1.04);opacity:1}
      100%{transform:translate(-50%,-150%) scale(1);opacity:0}
    }
    @keyframes drop{
      0%{transform:translate(-50%,-90%) scale(.92);opacity:0}
      20%{opacity:1}
      80%{transform:translate(-50%,25%) scale(1.04);opacity:1}
      100%{transform:translate(-50%,70%) scale(1);opacity:0}
    }
    .animUp{animation:rise var(--fxMs) cubic-bezier(.2,.9,.2,1) forwards}
    .animDown{animation:drop var(--fxMs) cubic-bezier(.2,.9,.2,1) forwards}
  </style>
</head>
<body>
  <div id="barWrapper">
    <div class="stat" id="s_Speed">
      <div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_speed.png" alt="Speed"></div>
      <div class="value" id="val_Speed">0</div>
      <div class="fx" id="fx_Speed"></div>
    </div>
    <div class="stat" id="s_Stamina">
      <div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_stamina.png" alt="Stamina"></div>
      <div class="value" id="val_Stamina">0</div>
      <div class="fx" id="fx_Stamina"></div>
    </div>
    <div class="stat" id="s_Power">
      <div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_power.png" alt="Power"></div>
      <div class="value" id="val_Power">0</div>
      <div class="fx" id="fx_Power"></div>
    </div>
    <div class="stat" id="s_Guts">
      <div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_guts.png" alt="Guts"></div>
      <div class="value" id="val_Guts">0</div>
      <div class="fx" id="fx_Guts"></div>
    </div>
    <div class="stat" id="s_Wit">
      <div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_wit.png" alt="Wit"></div>
      <div class="value" id="val_Wit">0</div>
      <div class="fx" id="fx_Wit"></div>
    </div>
  </div>

  <script>
    // chevrons
    const CHEV_UP   = 'https://erzombie.github.io/stream-player-repo/uma_overlay/uma_pos_chevron.png';
    const CHEV_DOWN = 'https://erzombie.github.io/stream-player-repo/uma_overlay/uma_neg_chevron.png';

    // per-stat tween state with merging
    const state = {
      Speed:   { cur:0, target:0, raf:null, t0:0, dur:900 },
      Stamina: { cur:0, target:0, raf:null, t0:0, dur:900 },
      Power:   { cur:0, target:0, raf:null, t0:0, dur:900 },
      Guts:    { cur:0, target:0, raf:null, t0:0, dur:900 },
      Wit:     { cur:0, target:0, raf:null, t0:0, dur:900 },
    };

    // init from query (?speed=…&stamina=…)
    const qs = new URLSearchParams(location.search);
    for (const k of Object.keys(state)){
      const v = parseInt(qs.get(k.toLowerCase()) || '0', 10);
      state[k].cur = state[k].target = isNaN(v) ? 0 : v;
      document.getElementById('val_'+k).textContent = state[k].cur;
    }

    function spawnChevron(stat, theme){
      const fx = document.getElementById('fx_'+stat);
      const img = new Image();
      img.src = (theme === 'down' ? CHEV_DOWN : CHEV_UP);
      img.className = 'chev ' + (theme === 'down' ? 'animDown' : 'animUp');
      fx.appendChild(img);
      setTimeout(()=> img.remove(), 950);
    }

    function tick(stat){
      const s = state[stat];
      const el = document.getElementById('val_'+stat);
      const now = performance.now();
      const p = Math.min(1, (now - s.t0) / s.dur);
      const e = 1 - Math.pow(1 - p, 3);       // easeOutCubic
      const val = Math.round(s.start + (s.target - s.start) * e);
      s.cur = val;
      el.textContent = val;

      if (p < 1){
        s.raf = requestAnimationFrame(()=>tick(stat));
      } else {
        // finished; if target changed during tween we immediately retarget
        if (s.target !== val){
          s.start = val; s.t0 = performance.now();
          s.raf = requestAnimationFrame(()=>tick(stat));
        } else {
          s.raf = null;
          el.classList.remove('pop'); void el.offsetWidth; el.classList.add('pop');
        }
      }
    }

    // Public: apply a delta (this is what Streamer.bot should call logically
    // at the same time you fire uma_stat.html)
    function applyDelta(stat, delta, theme='up'){
      const s = state[stat]; if (!s) return;
      // merge: push new target; if tween is idle start one
      s.start = s.cur;
      s.target += delta;
      s.t0 = performance.now();
      if (!s.raf) s.raf = requestAnimationFrame(()=>tick(stat));
      spawnChevron(stat, (delta < 0 || theme==='down') ? 'down' : 'up');
    }

    // postMessage API (so you can broadcast the same event to this overlay)
    // window.postMessage({ type:'umaDelta', stat:'Speed', delta: +7, theme:'up' })
    window.addEventListener('message',(e)=>{
      const m = e.data || {};
      if (m.type === 'umaDelta' && m.stat && typeof m.delta !== 'undefined'){
        applyDelta(m.stat, Number(m.delta), m.theme || (Number(m.delta) < 0 ? 'down' : 'up'));
      }
    });

    // optional demo: ?demo=1 shows two quick stacked deltas on Speed
    if (qs.get('demo') === '1'){
      setTimeout(()=>applyDelta('Speed',  96, 'up'),   500);
      setTimeout(()=>applyDelta('Stamina',50, 'up'),  900);
      setTimeout(()=>applyDelta('Power',  20, 'up'), 1300);
      setTimeout(()=>applyDelta('Guts',  -40, 'down'),1700);
      setTimeout(()=>applyDelta('Wit',   -30, 'down'),2100);

      // stacked hits to show merge behavior
      setTimeout(()=>applyDelta('Speed', +7, 'up'),  750);
      setTimeout(()=>applyDelta('Speed', +5, 'up'),  820);
    }

    // Expose for OBS “Execute JS” (optional)
    window.UmaBar = { applyDelta };
  </script>
</body>
</html>
