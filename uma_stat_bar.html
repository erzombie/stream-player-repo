<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Uma Stat Bar</title>
<style>
  :root{
    --font:'Roboto',system-ui,-apple-system,'Segoe UI',Arial,sans-serif;
    --brown:#3a2818;
    --cream:#f7efe0;
    --divider:#e1d6c6;
    --text:#4a2c0a;
    --fxMs:900ms;                 /* chevron anim time */
  }

  html,body{margin:0;background:transparent}
  body{font-family:var(--font);color:var(--text);display:flex;justify-content:center}

  /* bar */
  #bar{display:flex;gap:0;border-radius:14px;overflow:hidden;
       box-shadow:0 12px 26px rgba(0,0,0,.25); margin:18px auto}

  .stat{position:relative;min-width:160px;background:var(--cream);
        border-right:1px solid var(--divider); text-align:center}
  .stat:last-child{border-right:none}

  /* header label (PNG) */
  .label{background:var(--brown);height:46px;display:flex;align-items:center;justify-content:center}
  .label img{height:70%;width:auto;display:block;filter:drop-shadow(0 1px 2px rgba(0,0,0,.25))}

  /* value row */
  .value{position:relative;z-index:2;padding:12px 0 14px;font-size:44px;font-weight:900;line-height:1}

  /* FX layer only over number row (inside the box) */
  .fx{position:absolute;left:0;right:0;top:46px;bottom:0;pointer-events:none;z-index:1}

  .fx img.chev{position:absolute;left:50%;width:56px;opacity:.9;
               transform:translateX(-50%);filter:drop-shadow(0 8px 18px rgba(0,0,0,.35))}

  /* spawn & travel entirely within the number cell */
  .animUp  { top:82%; animation:rise var(--fxMs) cubic-bezier(.2,.9,.2,1) forwards; }
  .animDown{ top:18%; animation:drop var(--fxMs) cubic-bezier(.2,.9,.2,1) forwards; }

  @keyframes rise {
    0%   { transform:translate(-50%,  0%) scale(.96); opacity:0; }
    15%  { opacity:1; }
    100% { transform:translate(-50%,-70%) scale(1);  opacity:0; }
  }
  @keyframes drop {
    0%   { transform:translate(-50%,  0%) scale(.96); opacity:0; }
    15%  { opacity:1; }
    100% { transform:translate(-50%, 70%) scale(1);  opacity:0; }
  }

  /* number tween pop (subtle) */
  .pop{animation:valPop .45s ease-out}
  @keyframes valPop{0%{transform:scale(.96)}60%{transform:scale(1.06)}100%{transform:scale(1)}}
</style>
</head>
<body>
  <div id="bar">
    <div class="stat" id="s_Speed">
      <div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_speed.png" alt="Speed"></div>
      <div class="value" id="val_Speed">0</div>
      <div class="fx" id="fx_Speed"></div>
    </div>
    <div class="stat" id="s_Stamina">
      <div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_stamina.png" alt="Stamina"></div>
      <div class="value" id="val_Stamina">0</div>
      <div class="fx" id="fx_Stamina"></div>
    </div>
    <div class="stat" id="s_Power">
      <div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_power.png" alt="Power"></div>
      <div class="value" id="val_Power">0</div>
      <div class="fx" id="fx_Power"></div>
    </div>
    <div class="stat" id="s_Guts">
      <div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_guts.png" alt="Guts"></div>
      <div class="value" id="val_Guts">0</div>
      <div class="fx" id="fx_Guts"></div>
    </div>
    <div class="stat" id="s_Wit">
      <div class="label"><img src="https://erzombie.github.io/stream-player-repo/uma_overlay/bar_wit.png" alt="Wit"></div>
      <div class="value" id="val_Wit">0</div>
      <div class="fx" id="fx_Wit"></div>
    </div>
  </div>

<script>
/* Assets */
const CHEV_UP   = 'https://erzombie.github.io/stream-player-repo/uma_overlay/uma_pos_chevron.png';
const CHEV_DOWN = 'https://erzombie.github.io/stream-player-repo/uma_overlay/uma_neg_chevron.png';

/* Helpers */
const $ = (id)=>document.getElementById(id);
function tweenNumber(el, target, dur=650){
  const start = parseInt(el.textContent||'0',10);
  const diff  = target - start;
  if(!diff){ el.textContent = target; return; }
  const t0 = performance.now();
  function step(t){
    const p = Math.min(1,(t-t0)/dur);
    const e = 1 - Math.pow(1-p,3);               // easeOutCubic
    el.textContent = Math.round(start + diff*e);
    if(p<1) requestAnimationFrame(step); else { el.textContent = target; el.classList.remove('pop'); void el.offsetWidth; el.classList.add('pop'); }
  }
  requestAnimationFrame(step);
}
function spawnChevron(fxEl, dir){                // dir = 'up' | 'down'
  const im = new Image();
  im.src = (dir==='down') ? CHEV_DOWN : CHEV_UP;
  im.className = (dir==='down') ? 'chev animDown' : 'chev animUp';
  fxEl.appendChild(im);
  setTimeout(()=>im.remove(), 900);
}

/* Query parsing */
const qs = new URLSearchParams(location.search);

/* Initial totals (optional) */
const totals = {
  Speed:   parseInt(qs.get('speed')   || '0',10),
  Stamina: parseInt(qs.get('stamina') || '0',10),
  Power:   parseInt(qs.get('power')   || '0',10),
  Guts:    parseInt(qs.get('guts')    || '0',10),
  Wit:     parseInt(qs.get('wit')     || '0',10),
};
for(const k in totals){ $('val_'+k).textContent = totals[k]; }

/* Batch from uma_stat.html:
   stats=Wit|Wit|Speed
   amounts=7|7|10
   theme=up (applies to all; we still respect negative amounts)
   perMs=400  (optional; default 400)
   waitMs     (optional explicit override)
*/
const theme  = (qs.get('theme')||'up').toLowerCase();
const perMs  = parseInt(qs.get('perMs')||'400',10);
const statsL = (qs.get('stats')||'').split('|').filter(Boolean);
const amtsL  = (qs.get('amounts')||'').split('|').map(x=>parseInt(x,10)).filter(x=>!Number.isNaN(x));

/* Compute estimated wait time = instances * perMs, unless waitMs is provided */
const instances = Math.min(statsL.length, amtsL.length);
const waitMs    = parseInt(qs.get('waitMs')||'0',10) || (instances * perMs);

/* Sum by stat */
const sums = {Speed:0,Stamina:0,Power:0,Guts:0,Wit:0};
for(let i=0;i<instances;i++){
  const s = (statsL[i]||'').trim();
  if(sums.hasOwnProperty(s)) sums[s] += amtsL[i]||0;
}

/* After wait, apply one tween + chevron per changed stat */
function applyBatch(){
  for(const stat in sums){
    const delta = sums[stat];
    if(!delta) continue;

    const valEl = $('val_'+stat);
    const fxEl  = $('fx_'+stat);
    if(!valEl || !fxEl) continue;

    const target = (parseInt(valEl.textContent||'0',10) + delta);
    // Chevron direction: negative OR (theme=='down') => down, else up
    const dir = (delta<0 || theme==='down') ? 'down' : 'up';
    spawnChevron(fxEl, dir);
    tweenNumber(valEl, target, 650);
  }
}

/* Start */
setTimeout(applyBatch, waitMs);

/* Demo (optional): ?demo=1 */
if(qs.get('demo')==='1'){
  // Simulate: Wit+7, Wit+7, Speed+10  => wait 3*400ms = 1200ms
  setTimeout(()=>location.search='?stats=Wit|Wit|Speed&amounts=7|7|10&theme=up&perMs=400&demoOff=1',100);
}
</script>
</body>
</html>
