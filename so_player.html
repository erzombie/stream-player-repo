<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SO Player</title>

<style>
  html,body{margin:0;background:transparent;overflow:hidden}

  :root{
    /* tweak these to taste */
    --avatar-size: clamp(88px, 10vw, 140px);
    --name-size:   clamp(38px, 5.2vw, 72px);
    --msg-size:    clamp(18px, 2.6vw, 30px);
    --bar-bg: rgba(40,40,40,.88);
  }

  /* Layout: smaller video at left, big ID bar along bottom */
  #wrap{
    position:fixed; inset:0;
    display:grid; grid-template-columns: 40% 60%;
    align-items:center; justify-items:center; gap:2vw;
    pointer-events:none;
  }

  /* 16:9 video box (hidden when no clip) */
  #clipBox{
    width:100%;
    max-width:min(48vw, 90vh);
    aspect-ratio:16/9;
    border-radius:16px; overflow:hidden;
    background:#222; box-shadow:0 10px 36px rgba(0,0,0,.45);
  }
  #clipBox.hide{ display:none; }

  /* Identity bar */
  #bar{
    position:fixed; left:0; right:0; bottom:0;
    display:flex; align-items:center; gap:14px;
    padding:12px 18px;
    background:var(--bar-bg);
    color:#fff; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
  }
  #avatar{
    width:var(--avatar-size); height:var(--avatar-size);
    border-radius:50%; object-fit:cover;
    box-shadow:0 6px 18px rgba(0,0,0,.35);
  }
  #who{ font-weight:800; font-size:var(--name-size); line-height:1.05 }
  #msg{ font-size:var(--msg-size); opacity:.95 }
  #text{ display:flex; flex-direction:column }
</style>

<div id="wrap">
  <div id="clipBox"><div id="player"></div></div>
</div>

<div id="bar">
  <img id="avatar" alt="">
  <div id="text">
    <div id="who"></div>
    <div id="msg"></div>
  </div>
</div>

<!-- Official Twitch Embed -->
<script src="https://player.twitch.tv/js/embed/v1.js"></script>
<script>
(function(){
  const qs = new URLSearchParams(location.search);

  const name   = qs.get('name')   || '';
  const avatar = qs.get('avatar') || '';
  const vol    = Math.max(0, Math.min(1, parseFloat(qs.get('vol') || '0.35')));

  // clip can come as ?clipId=SLUG or ?clipUrl=https://www.twitch.tv/.../SLUG
  let slug = qs.get('clipId') || '';
  if (!slug) {
    const cu = qs.get('clipUrl') || '';
    const m = cu.match(/clip\/([^/?#]+)/i);
    if (m) slug = m[1];
  }

  document.getElementById('avatar').src = avatar || '';
  document.getElementById('who').textContent = name || '';
  document.getElementById('msg').textContent = 'Check out ' + (name || 'this creator') + '!';

  const clipBox = document.getElementById('clipBox');

  if (!slug) {           // No clip? show avatar+text only
    clipBox.classList.add('hide');
    return;
  }

  try {
    const parentHost = location.hostname; // github pages / obs browser source host
    const embed = new Twitch.Embed("player", {
      width: "100%",
      height: "100%",
      clip: slug,
      autoplay: true,
      muted: vol === 0,
      parent: [parentHost]
    });

    embed.addEventListener(Twitch.Embed.VIDEO_READY, () => {
      try {
        const player = embed.getPlayer();
        player.setVolume(vol);
        if (vol > 0) player.setMuted(false);
        player.play();
      } catch(e) {}
    });
  } catch(e) {
    console.log('embed error', e);
    clipBox.classList.add('hide');
  }
})();
</script>
