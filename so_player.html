<!doctype html>
<meta charset="utf-8">
<title>SO Player</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg:#000; --panel:#444; --text:#f3f3f3; --muted:#cfd2d6;
    --radius:18px; --shadow:0 12px 30px rgba(0,0,0,.35);
    --banner-h:120px; --gap:16px;
  }
  html,body{height:100%;margin:0;background:transparent;overflow:hidden;
    font-family:system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;color:var(--text)}
  #wrap{position:fixed;inset:0;display:grid;grid-template-rows:1fr minmax(var(--banner-h),auto);
    align-items:end;justify-items:center;background:transparent;padding:24px;box-sizing:border-box;gap:var(--gap)}

  /* Video box */
  #box{width:100%;max-width:92vw;max-height:calc(100vh - var(--banner-h) - var(--gap) - 48px);
    aspect-ratio:16/9;background:#111;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);
    display:grid;place-items:center}
  #player{width:100%;height:100%;border:0;display:none}
  /* Smaller, centered GIF (roughly like your older sizing) */
  #gif{display:none;max-width:78%;max-height:78%;height:auto;width:auto;border-radius:var(--radius);
    box-shadow:0 10px 28px rgba(0,0,0,.35);object-fit:contain;background:#000}

  /* Banner */
  #banner{width:clamp(520px,70vw,1100px);min-height:var(--banner-h);background:rgba(30,30,30,.86);
    border-radius:calc(var(--radius) + 6px);box-shadow:var(--shadow);display:grid;
    grid-template-columns:112px 1fr;align-items:center;padding:18px 26px 18px 18px;gap:18px}
  #avatar{width:92px;height:92px;border-radius:50%;box-shadow:inset 0 0 0 6px rgba(255,255,255,.06),0 6px 16px rgba(0,0,0,.4);
    background:#222 center/cover no-repeat}
  #name{font-size:clamp(28px,4.5vw,52px);line-height:1.05;font-weight:800;letter-spacing:.3px;margin:0 0 6px}
  #sub{margin:0;font-size:clamp(16px,2vw,26px);color:var(--muted);letter-spacing:.2px}

  #msg{position:fixed;top:8px;left:12px;color:#ccc;font:13px/1.5 ui-monospace,Menlo,Consolas,monospace;opacity:.65;display:none}
</style>

<div id="wrap">
  <div id="box">
    <div id="player"></div>
    <img id="gif" alt="so gif">
  </div>
  <div id="banner">
    <div id="avatar"></div>
    <div>
      <h1 id="name">Streamer</h1>
      <p id="sub">Check out Streamer!</p>
    </div>
  </div>
</div>
<div id="msg"></div>

<script>
(function(){
  const qs   = new URLSearchParams(location.search);
  const name = qs.get('name')    || 'Friend';
  const profile = qs.get('profile') || '';
  const clip = qs.get('clip') || '';          // slug/id
  const vol  = Math.max(0, Math.min(1, parseFloat(qs.get('vol')||'0')));
  const gif  = qs.get('gif') || '';
  const DEBUG= qs.has('debug');
  const $ = id => document.getElementById(id);
  const show = (el,on=true)=> el.style.display = on ? 'block' : 'none';
  const msg = t => { if(DEBUG){ $('msg').textContent=t; $('msg').style.display='block'; } };

  $('name').textContent = name;
  $('sub').textContent  = `Check out ${name}!`;
  if (profile) $('avatar').style.backgroundImage = `url("${profile.replace(/"/g,'&quot;')}")`;

  if (!clip) { if (gif){ $('gif').src = gif; show($('gif'),true);} msg('no clip → gif'); return; }

  const parents = ['localhost','127.0.0.1','obsproject.com','erzombie.github.io'];
  const s = document.createElement('script');
  s.src = "https://embed.twitch.tv/embed/v1.js";
  s.onload = () => {
    try {
      const embed = new Twitch.Embed("player", {
        width: "100%", height: "100%", clip, autoplay: true,
        muted: vol <= 0.0001, parent: parents
      });
      embed.addEventListener(Twitch.Embed.VIDEO_READY, () => {
        try {
          const player = embed.getPlayer();
          player.setMuted(false);
          player.setVolume(Math.max(0, Math.min(1, vol || 0.35)));
          player.play();
          show($('player'), true);
          show($('gif'), false);
          msg('player ready');
        } catch(e){ msg('ready but play/vol failed'); }
      });
      // 3s safety: if Twitch refuses to play, fallback to gif
      let timer = setTimeout(() => { if(gif){ $('gif').src = gif; show($('gif'),true); } show($('player'),false); msg('timeout → gif'); }, 3000);
      embed.addEventListener(Twitch.Embed.VIDEO_PLAY, () => { clearTimeout(timer); });
    } catch(e) {
      if (gif){ $('gif').src = gif; show($('gif'),true); }
      msg('embed error → gif');
    }
  };
  s.onerror = () => { if (gif){ $('gif').src = gif; show($('gif'),true); } msg('sdk load fail → gif'); };
  document.body.appendChild(s);
})();
</script>
