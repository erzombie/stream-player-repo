<!doctype html>
<meta charset="utf-8" />
<title>SO Player</title>
<style>
  :root{
    --banner-bg: rgba(60,60,60,.95);
    --text: #fff;
    --sub: #dcdcdc;
    --radius: 16px;
  }

  html,body{margin:0;background:transparent;overflow:hidden}

  /* Bottom banner container */
  #banner{
    position:fixed;
    left:24px; right:24px; bottom:24px;
    display:flex; align-items:center; gap:16px;
    padding:14px 18px;
    background:var(--banner-bg);
    color:var(--text);
    border-radius:var(--radius);
    box-shadow:0 10px 28px rgba(0,0,0,.35);
    overflow:hidden;                 /* clip child corners */
  }

  #avatar{
    width:68px; height:68px; border-radius:50%;
    border:4px solid rgba(0,0,0,.28);
    background:#222 center/cover no-repeat;
    flex:0 0 auto;
  }

  #texts{display:flex; flex-direction:column; line-height:1}
  #name{font:700 42px/1.05 system-ui,Segoe UI,Roboto,Arial,sans-serif; letter-spacing:.5px}
  #tag {font:500 20px/1.2 system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--sub); margin-top:10px}

  /* If you add a video box later, match radius */
  #videoWrap, #videoWrap video{
    border-radius:var(--radius);
    overflow:hidden;
  }
</style>

<div id="wrap">
  <div id="videoWrap"><div id="video"></div></div>
  <div id="bar">
    <img id="avatar" alt="">
    <div id="txt">
      <div id="name">Streamer</div>
      <div id="tag">Check out this awesome channel!</div>
    </div>
  </div>
</div>
<pre id="dbg"></pre>

<!-- Twitch embed API (more robust in OBS) -->
<script src="https://embed.twitch.tv/embed/v1.js"></script>
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const debug = qs.has('debug');
  const log = (...a)=>{ if(debug){ const d=document.getElementById('dbg'); d.style.display='block'; d.textContent += a.join(' ') + "\n"; } };

  // helpers
  const get = k => (qs.get(k) || "").trim();
  const setText = (id, t)=> document.getElementById(id).textContent = t;
  const byId = id => document.getElementById(id);

  // parse inputs
  const name = get('name') || 'Friend';
  const profile = get('profile');
  const vol = Math.max(0, Math.min(1, parseFloat(get('vol')||'0.35')));
  const durMs = parseInt(get('dur')||'7500',10);

  setText('name', name);
  setText('tag', `Check out ${name}!`);
  if (profile){
    const img = byId('avatar');
    img.src = profile;
    img.onerror = ()=>{ img.removeAttribute('src'); }; // keep the neutral circle
  }

  // Extract a clip slug from full URLs or accept a slug directly
  function clipSlug(x){
    if(!x) return "";
    try{
      if(!x.includes("://")) return x;           // already a slug
      const u = new URL(x);
      if (u.hostname.includes("clips.twitch.tv")){
        // https://clips.twitch.tv/<slug> or /embed?clip=<slug>
        const s1 = u.pathname.split('/').filter(Boolean)[0] || "";
        const s2 = u.searchParams.get('clip') || "";
        return s2 || s1;
      }
      if (u.hostname.includes("twitch.tv")){
        // https://www.twitch.tv/<channel>/clip/<slug>
        const parts = u.pathname.split('/').filter(Boolean);
        const i = parts.indexOf("clip");
        if (i>=0 && parts[i+1]) return parts[i+1];
      }
    }catch(e){}
    return "";
  }

  const slug = clipSlug(get('clip'));
  log("slug", slug, "vol", vol);

  // Show video only if we have a slug and embed succeeds
  if (slug){
    const parent = location.hostname; // e.g. erzombie.github.io
    try{
      const elWrap = byId('videoWrap');
      elWrap.style.display = 'block';

      const embed = new Twitch.Embed("video", {
        width: "100%",
        height: "100%",
        clip: slug,
        autoplay: true,
        muted: false,        // we'll set volume right away
        parent: [parent]     // Twitch requires parent domain
      });

      embed.addEventListener(Twitch.Player.READY, () => {
        try{
          const p = embed.getPlayer();
          p.setMuted(false);
          p.setVolume(vol);
          p.play();
          log("player ready");
        }catch(e){ log("player err", e+""); }
      });

      // If Twitch blocks the embed for any reason, keep banner-only
      setTimeout(()=>{ log("embed init timeout passed"); }, 1000);
    }catch(e){
      log("embed failed:", e+"");
      byId('videoWrap').style.display = 'none';
    }
  }

  // Auto-hide after duration if provided
  if (durMs > 0){
    setTimeout(()=>{ document.body.style.display='none'; }, durMs);
  }
})();
</script>
