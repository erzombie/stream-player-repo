<!doctype html>
<meta charset="utf-8" />
<title>SO Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --pad: 18px;
    --radius: 18px;
    --glass: rgba(0,0,0,.72);
    --text: #f2f2f2;
    --sub : #d0d0d0;
    --shadow: 0 18px 40px rgba(0,0,0,.35);
  }
  html,body{margin:0;height:100%;background:transparent;overflow:hidden}
  #root{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}

  /* Stage = 16:9 area for Twitch or GIF (kept big & centered) */
  #stage{
    position:absolute; inset:4% 3% 22% 3%;
    display:flex; align-items:center; justify-content:center;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    background:#111; /* hidden when gif-only */
  }
  /* keep a solid aspect even if iframe is still loading */
  #stage::before{ content:""; display:block; width:100%; aspect-ratio:16/9; }
  #player, #gif{
    position:absolute; inset:0; width:100%; height:100%;
    border:0; border-radius: var(--radius); display:none;
  }
  /* Big GIF */
  #gif{
    object-fit:contain;
    background:transparent;
    display:none;
  }
  /* Bottom-center banner */
  #banner{
    position:absolute; left:50%; bottom:3%;
    transform:translateX(-50%);
    display:flex; align-items:center; gap:14px;
    padding:14px 18px;
    background:var(--glass);
    border-radius: 16px;
    color:var(--text);
    font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
    box-shadow: var(--shadow);
    pointer-events:none;
  }
  #pfp{
    width:44px; height:44px; border-radius:50%;
    background:#222 center/cover no-repeat; flex:0 0 44px;
    box-shadow: inset 0 0 0 3px rgba(255,255,255,.08);
  }
  #who{ line-height:1.1 }
  #name{ font-size:28px; font-weight:800; letter-spacing:.3px }
  #line{ font-size:14px; color:var(--sub) }

  /* When weâ€™re gif-only, remove the stage background and let GIF breathe */
  .gifOnly #stage{ background:transparent; }
  .gifOnly #gif{ display:block; width: min(92vw, 92vh); height:auto; inset:auto; }
</style>

<div id="root">
  <div id="stage">
    <iframe id="player" allow="autoplay; fullscreen; picture-in-picture"></iframe>
    <img id="gif" alt="so gif"/>
  </div>

  <div id="banner">
    <div id="pfp"></div>
    <div id="who">
      <div id="name"></div>
      <div id="line"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const qs      = new URLSearchParams(location.search);
  const clip    = (qs.get('clip')    || '').trim();
  const vod     = (qs.get('vod')     || '').trim();
  const name    = (qs.get('name')    || 'Friend').trim();
  const profile = (qs.get('profile') || '').trim();
  const vol     = Math.max(0, Math.min(1, parseFloat(qs.get('vol')||'0.35') || 0.35));
  const durMs   = parseInt(qs.get('dur') || '0', 10);
  const gifList = (qs.get('giflist') || '').trim(); // optional index.txt (one path per line)
  const HOST    = location.hostname || 'localhost';

  // Banner
  document.getElementById('name').textContent = name;
  document.getElementById('line').textContent = 'Check out ' + name + '!';
  if (profile) document.getElementById('pfp').style.backgroundImage = `url("${profile}")`;

  const stage  = document.getElementById('stage');
  const player = document.getElementById('player');
  const gifEl  = document.getElementById('gif');

  const showPlayer = (src) => {
    player.src = src;
    player.style.display = 'block';
    gifEl.style.display = 'none';
    stage.classList.remove('gifOnly');
  };

  const showGif = async () => {
    let url = 'assets/hellothere.gif';
    if (gifList){
      try{
        const r = await fetch(gifList, {cache:'no-store'});
        if (r.ok){
          const lines = (await r.text()).split(/\r?\n/)
              .map(s=>s.trim())
              .filter(s=>s && !s.startsWith('#'));
          if (lines.length){
            url = lines[Math.floor(Math.random()*lines.length)];
          }
        }
      }catch{}
    }
    gifEl.src = url;
    gifEl.style.display = 'block';
    player.style.display = 'none';
    stage.classList.add('gifOnly');
  };

  const muted = (vol <= 0);

  if (clip){
    // Twitch Clip embed
    const src = `https://clips.twitch.tv/embed?clip=${encodeURIComponent(clip)}&parent=${encodeURIComponent(HOST)}&autoplay=true&muted=${muted?'true':'false'}`;
    showPlayer(src);
  } else if (vod){
    // Twitch VOD embed
    const src = `https://player.twitch.tv/?video=${encodeURIComponent(vod)}&parent=${encodeURIComponent(HOST)}&autoplay=true&muted=${muted?'true':'false'}`;
    showPlayer(src);
  } else {
    showGif();
  }

  // Optional page self-timeout only if dur is provided (SB still owns the hide)
  if (durMs > 0){
    setTimeout(()=>{ /* no-op; SB hides source */ }, durMs);
  }
})();
</script>
