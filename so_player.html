<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta
  http-equiv="Content-Security-Policy"
  content="default-src 'self' https: data: blob:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https://embed.twitch.tv https://clips.twitch.tv; frame-src https://player.twitch.tv https://clips.twitch.tv https://www.twitch.tv; media-src * data: blob:; img-src * data:; connect-src *">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SO Player</title>
<!-- Twitch embed SDK for VOD/live -->
<script src="https://embed.twitch.tv/embed/v1.js"></script>
<style>
  :root{
    --radius: 16px;
    --shadow: 0 16px 40px rgba(0,0,0,.45);
    --banner-bg: rgba(30,30,30,.88);
    --text: #fff;
    --muted: #cbd5e1;
    --accent: #ffffff;
  }
  html,body{
    height:100%; width:100%; margin:0; background:transparent; color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  }
  .wrap{
    height:100%; width:100%;
    display:grid;
    grid-template-rows: 4fr 1fr; /* ~80% video / 20% banner */
    align-items:center;
    justify-items:center;
    gap:14px;
    background:transparent;
  }

  /* Stage (video or gif) */
  #stage{
    width:min(92vw, 92vh*16/9); /* keep 16:9, max to viewport */
    aspect-ratio:16/9;
    display:grid; place-items:center;
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    background:#101114; /* visible only when a video is present */
    overflow:hidden;
  }
  #stage.transparent{ background:transparent; box-shadow:none; }

  /* Twitch containers */
  #twclip, #twvod { width:100%; height:100%; border:0; }

  /* GIF fallback â€“ big and centered */
  #gif{
    display:none;
    max-width:96%;
    max-height:96%;
    height:auto; width:auto;
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    object-fit:contain;
    background:transparent;
  }

  /* Banner */
  .banner{
    display:flex; align-items:center; gap:14px;
    background:var(--banner-bg);
    border-radius:20px;
    padding:14px 18px;
    width:min(68vw, 1100px); /* wider banner */
    box-shadow:var(--shadow);
    backdrop-filter: blur(6px);
  }
  .pfp{
    width:54px; height:54px; border-radius:999px;
    box-shadow: inset 0 0 0 3px rgba(255,255,255,.1);
    background:#222 center/cover no-repeat;
    flex:0 0 auto;
  }
  .meta{
    line-height:1.2;
  }
  .name{
    font-weight:900; font-size:40px; letter-spacing:.3px;
  }
  .sub{
    color:var(--muted); font-size:18px;
  }

  /* Small screens (just in case) */
  @media (max-width:900px){
    .name{ font-size:28px; }
    .sub{ font-size:14px; }
    .pfp{ width:44px; height:44px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div id="stage" class="transparent">
      <!-- one of these gets used -->
      <iframe id="twclip" allow="autoplay; fullscreen" style="display:none;"></iframe>
      <div id="twvod" style="display:none;"></div>
      <img id="gif" alt="gif fallback" />
    </div>

    <div class="banner" id="banner">
      <div class="pfp" id="pfp"></div>
      <div class="meta">
        <div class="name" id="nameTxt">Guest</div>
        <div class="sub" id="subTxt">Check out our friend!</div>
      </div>
    </div>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const PARENT = location.hostname;               // required by Twitch
  const name    = qs.get('name')    || 'Friend';
  const profile = qs.get('profile') || '';
  const clip    = qs.get('clip')    || '';        // Twitch clip slug
  const vod     = qs.get('vod')     || '';        // Twitch VOD id
  const vodStart= +(qs.get('vodStart') || 0);     // seconds
  const vol     = Math.max(0, Math.min(1, +(qs.get('vol')||0.35)));
  const passedDur = +(qs.get('dur')||0);          // ms you pass from SB
  const wantRandomGif = (qs.get('gif')||'').toLowerCase() === 'random';

  // DOM refs
  const stage  = document.getElementById('stage');
  const twclip = document.getElementById('twclip');
  const twvod  = document.getElementById('twvod');
  const gif    = document.getElementById('gif');

  // Banner
  document.getElementById('nameTxt').textContent = name;
  document.getElementById('subTxt').textContent  = `Check out ${name}!`;
  if (profile) document.getElementById('pfp').style.backgroundImage = `url("${profile}")`;

  // --- Helper: pick random gif from /assets/gifs.txt
  async function pickRandomGif(){
    try{
      const base = location.href.replace(/\/so_player\.html.*/,'');
      const listUrl = base + '/assets/gifs.txt';
      const res = await fetch(listUrl, {cache:'no-store'});
      if (!res.ok) throw new Error('gifs.txt not found');
      const txt = await res.text();
      const items = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      if (items.length) {
        const choice = items[Math.floor(Math.random()*items.length)];
        return choice.startsWith('http') ? choice : (base + '/assets/' + choice.replace(/^assets\//,''));
      }
    }catch(e){ /* ignore */ }
    // default
    const base = location.href.replace(/\/so_player\.html.*/,'');
    return base + '/assets/hellothere.gif';
  }

  function showGif(url){
    stage.classList.add('transparent');
    gif.src = url;
    gif.style.display = 'block';
    twclip.style.display = 'none';
    twvod.style.display  = 'none';
  }

  function showClip(slug){
    stage.classList.remove('transparent');
    const src = `https://clips.twitch.tv/embed?clip=${encodeURIComponent(slug)}&parent=${encodeURIComponent(PARENT)}&autoplay=true&muted=true`;
    twclip.src = src;
    twclip.style.display = 'block';
    twvod.style.display  = 'none';
    gif.style.display    = 'none';
  }

  function showVod(id, start){
    stage.classList.remove('transparent');
    twclip.style.display = 'none';
    gif.style.display    = 'none';
    twvod.style.display  = 'block';

    const e = new Twitch.Embed('twvod', {
      width: '100%',
      height: '100%',
      layout: 'video',
      video: id,
      time: start > 0 ? start + 's' : undefined,
      autoplay: true,
      muted: true,         // unmute after READY if possible
      parent: [PARENT]
    });

    e.addEventListener(Twitch.Embed.VIDEO_READY, () => {
      try {
        const player = e.getPlayer();
        player.setMuted(false);
        player.setVolume(vol);
        // Seek to middle if we didn't get time param but want a nice section:
        if (!start) {
          // try a small seek to trigger playback visually
          player.seek(1);
        }
      } catch(_) {}
    });
  }

  async function run(){
    let mode = 'gif';
    if (clip) {
      mode = 'clip';
      showClip(clip);
    } else if (vod) {
      mode = 'vod';
      showVod(vod, vodStart);
    } else {
      const url = wantRandomGif ? await pickRandomGif() : (location.href.replace(/\/so_player\.html.*/,'') + '/assets/hellothere.gif');
      showGif(url);
    }

    // Duration: gif = 6000ms cap, video = passedDur (default 12000 by your render)
    let dur = passedDur > 0 ? passedDur : (mode === 'gif' ? 6000 : 12000);
    if (mode === 'gif') dur = Math.min(dur, 6000);

    setTimeout(() => { window.close && window.close(); }, dur);
  }

  run();
})();
</script>
</body>
</html>
