<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SO Player</title>
<style>
  :root{
    --radius:16px;
    --bannerBg: rgba(32,32,32,.92);
    --bannerText:#fff;
    --muted:#d6d6d6;
    --shadow: 0 14px 38px rgba(0,0,0,.35);
    --overscan: 4%;               /* show rounded corners nicely in OBS */
  }
  html,body{height:100%;width:100%;margin:0;background:transparent;overflow:hidden;
            font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;}

  #stage{position:fixed;inset:0;background:transparent;}

  /* Video container */
  #playerBox{
    position:absolute;left:50%;top:6vh;transform:translateX(-50%);
    width:min(92vw,160vh);
    height:min(78vh,51.75vw);
    border-radius:var(--radius);
    overflow:hidden;
    background:rgba(0,0,0,.65);
    box-shadow:var(--shadow);
    display:flex;align-items:center;justify-content:center;
  }
  #player{position:relative;width:100%;height:100%;}
  #twitch,#clipFrame,#gif{width:100%;height:100%}

  /* overscan the players so rounded corners are visible */
  #twitch{position:absolute;inset:0}
  #twitch iframe{
    position:absolute!important;left:calc(-1*var(--overscan));top:calc(-1*var(--overscan));
    width:calc(100% + var(--overscan)*2);height:calc(100% + var(--overscan)*2);border:0;
  }
  #clipFrame{
    position:absolute;left:calc(-1*var(--overscan));top:calc(-1*var(--overscan));
    width:calc(100% + var(--overscan)*2);height:calc(100% + var(--overscan)*2);border:0;display:none;
  }
  #gif{display:none;object-fit:contain;background:transparent}

  /* Banner */
  #banner{
    position:absolute;left:50%;bottom:4.5vh;transform:translateX(-50%);
    display:flex;align-items:center;gap:clamp(12px,1.8vw,28px);
    padding:clamp(14px,1.4vw,26px) clamp(18px,2.2vw,34px);
    background:var(--bannerBg);color:var(--bannerText);
    border-radius:14px;box-shadow:var(--shadow);max-width:min(88vw,1400px);
    pointer-events:none;
  }
  #avatarWrap{width:clamp(64px,8vw,112px);height:clamp(64px,8vw,112px);
              border-radius:999px;overflow:hidden;border:clamp(2px,.5vw,4px) solid rgba(0,0,0,.35);
              box-shadow:inset 0 0 0 2px rgba(255,255,255,.08);flex:0 0 auto}
  #avatar{width:100%;height:100%;object-fit:cover;display:block}
  #name{font-weight:900;font-size:clamp(28px,4vw,64px);line-height:1.05;letter-spacing:.2px}
  #tag{font-size:clamp(16px,2vw,28px);color:var(--muted);margin-top:clamp(2px,.3vw,6px)}
  #textCol{display:flex;flex-direction:column}
</style>
</head>
<body>
<div id="stage">
  <div id="playerBox">
    <div id="player">
      <div id="twitch" style="display:none"></div>
      <iframe id="clipFrame" allow="autoplay; fullscreen; picture-in-picture" style="display:none"></iframe>
      <img id="gif" alt="so-fallback" />
    </div>
  </div>

  <div id="banner" role="complementary" aria-live="polite">
    <div id="avatarWrap"><img id="avatar" src="" alt="avatar"></div>
    <div id="textCol">
      <div id="name">Friend</div>
      <div id="tag">Check out Friend!</div>
    </div>
  </div>
</div>

<script>
(function(){
  /* ---------- param helpers ---------- */
  const Q = new URLSearchParams(location.search);
  const ALIAS = {
    name:['name','displayName','user','username','target'],
    profile:['profile','avatar','pfp','image','img'],
    clip:['clip','clipId','slug'],
    vid:['vid','video','videoId','vod'],          // we will treat ONLY highlights here
    vol:['vol','volume'],
    dur:['dur','duration','ms'],
    text:['text','banner','subtitle'],
    gif:['gif','fallback']
  };
  const unresolved = v => /^%.*%$/.test(v||'');
  function getParam(key, def=''){
    for (const k of (ALIAS[key]||[key])){
      if (Q.has(k)){ const v = Q.get(k); return unresolved(v) ? def : (v ?? def); }
    }
    return def;
  }
  function getNum(key, def){
    const v = parseFloat(getParam(key,''));
    return Number.isFinite(v) ? v : def;
  }

  /* ---------- parsed params ---------- */
  const P = {
    name:    getParam('name','Friend'),
    profile: getParam('profile',''),
    clip:    getParam('clip',''),     // prefer this
    vid:     getParam('vid',''),      // highlight (not archive)
    vol:     Math.max(0, Math.min(1, getNum('vol',0.35))),
    dur:     (function(){ const d=parseInt(getParam('dur',''),10);
               return (Number.isFinite(d) && d>0) ? d : 12000; })(),
    text:    getParam('text',''),
    gif:     getParam('gif','random')
  };

  /* ---------- banner ---------- */
  document.getElementById('name').textContent = P.name;
  document.getElementById('tag').textContent  = P.text || `Check out ${P.name}!`;
  if (P.profile) document.getElementById('avatar').src = P.profile;

  /* ---------- env for Twitch embeds ---------- */
  const host = (location.hostname || 'localhost');
  const parents = [host,'localhost','127.0.0.1'].filter((v,i,a)=>v && a.indexOf(v)===i);
  const parentQS = parents.map(p=>'parent='+encodeURIComponent(p)).join('&');

  /* ---------- elements ---------- */
  const twDiv = document.getElementById('twitch');
  const clipI = document.getElementById('clipFrame');
  const gif   = document.getElementById('gif');

  /* ---------- gif pool ---------- */
  const gifPool = [
    '/stream-player-repo/assets/hellothere.gif',
    '/stream-player-repo/assets/hellothere2.gif',
    '/stream-player-repo/assets/blinkguy.gif',
    '/stream-player-repo/assets/bocchi.gif',
    '/stream-player-repo/assets/elmo.gif',
    '/stream-player-repo/assets/lick-anime.gif'
  ];
  function pickGif(arg){
    if (!arg || arg==='random') return gifPool[Math.floor(Math.random()*gifPool.length)];
    return arg;
  }

  /* ---------- teardown + show gif ---------- */
  function teardownPlayers(){
    // kill clip iframe
    try{
      clipI.src = 'about:blank';
      clipI.removeAttribute('src');
      clipI.style.display = 'none';
    }catch{}
    // kill twitch embed
    try{ twDiv.innerHTML = ''; twDiv.style.display = 'none'; }catch{}
  }
  function showGif(arg){
    teardownPlayers();
    gif.src = pickGif(arg);
    gif.style.display = 'block';
  }

  /* ---------- timer ---------- */
  let hideTimer = null;
  function startTimer(ms){
    if (hideTimer) clearTimeout(hideTimer);
    hideTimer = setTimeout(()=>{}, ms); // SB hides layer; we just keep a guard
  }

  /* ---------- Logic: Clip > Highlight > GIF ---------- */
  const START_DEADLINE_MS = 2000;     // 2s to prove it can start

  if (P.clip) {
    // Use the official clip embed; MUST be muted to autoplay
    const url = `https://clips.twitch.tv/embed?clip=${encodeURIComponent(P.clip)}&autoplay=true&muted=true${parentQS?('&'+parentQS):''}`;
    let started = false;

    clipI.onload = ()=>{ started = true; startTimer(P.dur); };
    clipI.src = url;
    clipI.style.display = 'block';
    twDiv.style.display = 'none';
    gif.style.display = 'none';

    setTimeout(()=>{ if (!started) showGif(P.gif); }, START_DEADLINE_MS);
  }
  else if (P.vid) {
    // We treat 'vid' as a HIGHLIGHT. If it can't start quickly, fallback to GIF.
    const s = document.createElement('script');
    s.src = 'https://player.twitch.tv/js/embed/v1.js';
    s.onload = () => {
      let playing = false;
      try{
        const embed = new Twitch.Embed('twitch', {
          width:'100%', height:'100%',
          video: P.vid,
          autoplay: true,
          muted: true,               // autoplay-friendly
          allowfullscreen: true,
          parent: parents
        });
        twDiv.style.display = 'block';
        clipI.style.display = 'none';
        gif.style.display = 'none';

        embed.addEventListener(Twitch.Embed.VIDEO_READY, () => {
          try{ embed.getPlayer().play(); }catch{}
        });
        embed.addEventListener(Twitch.Embed.PLAY, () => {
          playing = true;
          try{ const pl = embed.getPlayer(); pl.setVolume(P.vol||0); if ((P.vol||0)>0) pl.setMuted(false); }catch{}
          startTimer(P.dur);
        });
      }catch{
        showGif(P.gif);
        return;
      }
      setTimeout(()=>{ if (!playing) showGif(P.gif); }, START_DEADLINE_MS);
    };
    s.onerror = ()=> showGif(P.gif);
    document.body.appendChild(s);
  }
  else {
    // nothing provided -> GIF
    showGif(P.gif);
    startTimer(6000);
  }
})();
</script>
</body>
</html>
