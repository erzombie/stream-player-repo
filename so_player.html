<!doctype html>
<meta charset="utf-8" />
<title>Shoutout Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root{
    --bg: transparent;
    --panel: rgba(62,62,62,.94);
    --text: #fff;
    --text-sub: #ddd;
    --shadow: 0 16px 48px rgba(0,0,0,.35);
    --radius: 18px;
  }

  html, body { height:100%; }
  body{
    margin:0;
    background:var(--bg);
    font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
  }

  /* Stage */
  #root{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    pointer-events:none;
  }
  /* Column is sized so the clip looks big in 1080p browser source */
  #col{
    width:min(90vw, 96vh);          /* responsive width */
    max-width: 1200px;              /* cap for ultra-wide scenes */
    display:flex; flex-direction:column; align-items:center; gap:16px;
  }

  /* Video box */
  #vidBox{
    width:100%;
    aspect-ratio:16 / 9;
    background:#000;
    border-radius:var(--radius);
    overflow:hidden;
    box-shadow:var(--shadow);
    position:relative;
  }
  #player, #gif {
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    display:none;
  }

  /* Bottom banner directly under the video */
  #banner{
    pointer-events:auto;           /* let OBS click-through ignore it anyway */
    display:flex; align-items:center; gap:18px;
    background:var(--panel);
    color:var(--text);
    padding:14px 20px;
    border-radius:var(--radius);
    box-shadow:var(--shadow);
  }
  #avatar{
    width:72px; height:72px;
    border-radius:50%;
    background:#1f1f1f;
    box-shadow: inset 0 0 0 4px rgba(0,0,0,.35);
    flex:0 0 auto;
  }
  #name{
    font-weight:900;
    font-size:42px;
    line-height:1;
    letter-spacing:.3px;
  }
  #sub{
    margin-top:4px;
    font-weight:600;
    font-size:22px;
    color:var(--text-sub);
    line-height:1.1;
  }
  .vcol{ display:flex; flex-direction:column; }

  /* gentle fade */
  .show{ animation:fade .25s ease-out forwards; }
  @keyframes fade { from{opacity:0} to{opacity:1} }
</style>

<div id="root">
  <div id="col">
    <div id="vidBox">
      <div id="player"></div>
      <img id="gif" alt="placeholder gif"/>
    </div>

    <div id="banner" class="show">
      <img id="avatar" alt="avatar"/>
      <div class="vcol">
        <div id="name">Streamer</div>
        <div id="sub">Check out Streamer!</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const name    = (qs.get('name') || 'Friend').trim();
  const profile = (qs.get('profile') || '').trim();
  const clip    = (qs.get('clip') || '').trim();      // Twitch clip slug (e.g. Politeâ€¦)
  const gifUrl  = (qs.get('gif') || '').trim();       // optional GIF fallback
  const vol     = Math.max(0, Math.min(1, parseFloat(qs.get('vol')||'0.35') || 0.35));
  const parent  = location.hostname || 'localhost';   // Twitch parent requirement

  // Fill banner
  document.getElementById('name').textContent = name;
  document.getElementById('sub').textContent  = 'Check out ' + name + '!';
  const avatar = document.getElementById('avatar');
  if (profile) { avatar.src = profile; avatar.classList.add('show'); }
  else { avatar.style.opacity = .65; }

  const playerHost = document.getElementById('player');
  const gif = document.getElementById('gif');

  function showGif() {
    if (gifUrl) { gif.src = gifUrl; gif.style.display = 'block'; gif.classList.add('show'); }
  }

  if (clip){
    // Use Twitch Player API so we can set volume
    const s = document.createElement('script');
    s.src = "https://player.twitch.tv/js/embed/v1.js";
    s.onload = () => {
      try{
        const p = new Twitch.Player("player", {
          width: "100%",
          height: "100%",
          clip,
          autoplay: true,
          muted: false,              // we will try with sound; OBS generally allows this
          parent: [parent]
        });
        playerHost.style.display = 'block'; playerHost.classList.add('show');

        // Set volume once ready; if autoplay fails, Twitch will still render with a play button
        p.addEventListener(Twitch.Player.READY, () => {
          try { p.setVolume(vol); } catch {}
        });

        // If the player errors or never starts, fall back to GIF after a short grace period
        let started = false;
        const fallTimer = setTimeout(() => { if(!started) { try{ p.pause(); }catch{} showGif(); } }, 2500);
        p.addEventListener(Twitch.Player.PLAY, () => { started = true; clearTimeout(fallTimer); });
        p.addEventListener(Twitch.Player.ONLINE, () => { started = true; clearTimeout(fallTimer); });
        p.addEventListener(Twitch.Player.ERROR,  () => { showGif(); });
      }catch(e){
        showGif();
      }
    };
    s.onerror = showGif;
    document.head.appendChild(s);
  }else{
    // No clip provided: show GIF center (if provided) and keep the banner
    showGif();
  }
})();
</script>
