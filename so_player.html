<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SO Player</title>
<style>
  :root{
    --radius:16px;
    --bannerBg: rgba(32,32,32,.92);
    --bannerText:#fff;
    --muted:#d6d6d6;
    --shadow: 0 14px 38px rgba(0,0,0,.35);
  }
  html,body{height:100%; width:100%; margin:0; background:transparent; overflow:hidden; font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;}
  #stage{position:fixed; inset:0; background:transparent;}
  /* Video box takes ~80% vertical space, centered */
  #playerBox{
    position:absolute;
    left:50%;
    top:6vh;
    transform:translateX(-50%);
    width:min(92vw, 160vh);             /* keep 16:9-ish while respecting viewport */
    height:min(78vh, 51.75vw);          /* 16:9 of width, capped by 78vh */
    border-radius:var(--radius);
    overflow:hidden;
    background:rgba(0,0,0,.65);         /* dark plate behind player/gif; comment this for full transparency */
    box-shadow: var(--shadow);
    display:flex; align-items:center; justify-content:center;
  }
  #player, #twitch, #clipFrame, #gif{
    width:100%; height:100%;
  }
  #clipFrame{border:0;}
  #gif{ display:none; object-fit:contain; background:transparent; }

  /* Bottom banner (~20% vibe) */
  #banner{
    position:absolute; left:50%; bottom:4.5vh; transform:translateX(-50%);
    display:flex; align-items:center; gap:14px;
    padding:14px 22px;
    background:var(--bannerBg);
    color:var(--bannerText);
    border-radius:14px;
    box-shadow: var(--shadow);
    max-width:min(88vw, 1200px);
  }
  #avatarWrap{
    width:48px; height:48px; border-radius:999px; overflow:hidden;
    border:3px solid rgba(0,0,0,.35); box-shadow: inset 0 0 0 2px rgba(255,255,255,.08);
    flex:0 0 48px;
  }
  #avatar{ width:100%; height:100%; object-fit:cover; display:block; }
  #name{ font-weight:800; font-size:28px; line-height:1; letter-spacing:.2px; }
  #tag { font-size:16px; color:var(--muted); margin-top:2px; }
  #textCol{ display:flex; flex-direction:column; }
</style>
</head>
<body>
<div id="stage">
  <div id="playerBox">
    <div id="player">
      <!-- VOD uses #twitch via JS Embed; clip uses #clipFrame; gif uses #gif -->
      <div id="twitch" style="width:100%;height:100%;display:none;"></div>
      <iframe id="clipFrame" style="display:none;" allow="autoplay; fullscreen"></iframe>
      <img id="gif" alt="so-fallback" />
    </div>
  </div>

  <div id="banner" role="complementary" aria-live="polite">
    <div id="avatarWrap"><img id="avatar" src="" alt="avatar"></div>
    <div id="textCol">
      <div id="name">Friend</div>
      <div id="tag">Check out Friend!</div>
    </div>
  </div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const name    = qs.get('name')    || 'Friend';
  const profile = qs.get('profile') || '';
  const clipId  = qs.get('clip')    || '';
  const vodId   = qs.get('vod')     || '';
  const vodStart= qs.get('vodStart')|| ''; // seconds
  const vol     = Math.max(0, Math.min(1, parseFloat(qs.get('vol')||'0.35') || 0.35));
  const durMs   = Math.max(1000, parseInt(qs.get('dur')||'12000', 10));
  const gifArg  = qs.get('gif') || '';     // "", "random", or an explicit path

  // Banner text + avatar
  document.getElementById('name').textContent = name;
  document.getElementById('tag').textContent  = `Check out ${name}!`;
  const av = document.getElementById('avatar');
  if (profile) av.src = profile;

  // Compose Twitch "parent" list
  const host = (location.hostname || 'localhost');
  const parents = [host, 'localhost', '127.0.0.1'];
  const parentQS = parents
      .filter((v,i,a)=>v && a.indexOf(v)===i)
      .map(p => 'parent=' + encodeURIComponent(p))
      .join('&');

  // Elements
  const twDiv = document.getElementById('twitch');
  const clipI = document.getElementById('clipFrame');
  const gif   = document.getElementById('gif');

  // Random GIF list (add more in /assets)
  const gifPool = [
    '/stream-player-repo/assets/hellothere.gif'
    // '/stream-player-repo/assets/another1.gif',
    // '/stream-player-repo/assets/another2.gif',
  ];

  function showGif(src){
    let gsrc = src;
    if (!gsrc || gsrc === 'random') {
      gsrc = gifPool[Math.floor(Math.random()*gifPool.length)];
    }
    gif.src = gsrc;
    gif.style.display = 'block';
    clipI.style.display = 'none';
    twDiv.style.display = 'none';
  }

  // Timer control: only start the “video duration” if we truly have a ready player
  let hideTimer = null;
  function startTimer(ms){
    if (hideTimer) clearTimeout(hideTimer);
    hideTimer = setTimeout(()=>{ /* nothing to do here; SB hides the layer */ }, ms);
  }

  // --- Priority: VOD > Clip > GIF ---
  if (vodId) {
    // Load Twitch Embed JS
    const s = document.createElement('script');
    s.src = 'https://player.twitch.tv/js/embed/v1.js';
    s.onload = () => {
      try{
        const embed = new Twitch.Embed('twitch', {
          width: '100%',
          height:'100%',
          video: vodId,
          time: vodStart ? `0h0m${parseInt(vodStart,10)||0}s` : undefined,
          autoplay: true,
          muted: vol === 0,
          allowfullscreen: true,
          // IMPORTANT: parent must match your domain
          parent: parents
        });
        twDiv.style.display = 'block';
        clipI.style.display = 'none';
        gif.style.display    = 'none';

        let ready = false;
        embed.addEventListener(Twitch.Embed.VIDEO_READY, () => {
          ready = true;
          try{
            const player = embed.getPlayer();
            player.setVolume(vol);
            player.play();
          }catch(e){}
          startTimer(durMs);
        });

        // If we never become ready (blocked or removed), fall back to GIF quickly
        setTimeout(()=>{ if (!ready) showGif(gifArg||'random'); }, 1800);
      }catch(e){
        // Any failure → GIF fallback
        showGif(gifArg||'random');
        startTimer(6000);
      }
    };
    s.onerror = () => { showGif(gifArg||'random'); startTimer(6000); };
    document.body.appendChild(s);
  }
  else if (clipId) {
    // Twitch Clips embed (must include parent list)
    const url = `https://clips.twitch.tv/embed?clip=${encodeURIComponent(clipId)}&autoplay=true&muted=${vol===0}${parentQS ? '&'+parentQS : ''}`;
    clipI.src = url;
    clipI.style.display = 'block';
    twDiv.style.display = 'none';
    gif.style.display   = 'none';

    // We can't get reliable events from cross-origin iframe → optimistic timer.
    // If the clip is “no longer available”, the user will see the Twitch ghost,
    // but we’ll still end on time.
    startTimer(durMs);
  }
  else {
    // No video → GIF
    showGif(gifArg||'random');
    startTimer(6000);
  }
})();
</script>
</body>
</html>
