<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SO Player</title>

<style>
  :root{
    --bg: rgba(60,60,60,.95);
    --text: #fff;
    --sub: #dcdcdc;
    --radius: 16px;
    --shadow: 0 14px 40px rgba(0,0,0,.35);
  }
  html,body{margin:0;background:transparent;overflow:hidden;height:100%}

  /* ======== VIDEO BOX (top-left) ======== */
  #videoWrap{
    position:fixed; top:24px; left:24px;
    width:min(36vw, 640px);
    aspect-ratio:16/9;
    background:#222;
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
    display:none;                  /* shown only when clip exists */
  }
  #videoWrap iframe{width:100%;height:100%;border:0;display:block}

  /* ======== GIF FALLBACK (centered on canvas) ======== */
  #gifWrap{
    position:fixed; inset:0; display:none;
    align-items:center; justify-content:center;
    pointer-events:none;
  }
  #gifWrap img{
    max-width:min(48vw, 720px);
    width:100%;
    height:auto;
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    object-fit:cover;
  }

  /* ======== BANNER ======== */
  #banner{
    display:flex; align-items:center; gap:16px;
    padding:14px 18px;
    background:var(--bg);
    color:var(--text);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
    max-width:min(92vw, 1200px);
  }
  /* default: fixed bottom-center (used in gif/no-clip mode) */
  #banner.fixed{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:24px;
  }
  /* when inside video: absolute bottom-center of the video box */
  #banner.inVideo{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:10px;
  }

  #avatar{
    width:68px;height:68px;flex:0 0 auto;
    border-radius:50%;
    background:#222 center/cover no-repeat;
    border:4px solid rgba(0,0,0,.28);
  }
  #name{font:700 42px/1.05 system-ui, Segoe UI, Roboto, Arial, sans-serif; letter-spacing:.5px}
  #tag {font:500 20px/1.2  system-ui, Segoe UI, Roboto, Arial, sans-serif; color:var(--sub); margin-top:10px}
  #texts{display:flex;flex-direction:column}

  @media (max-width:900px){
    #name{font-size:34px}
    #tag {font-size:18px}
    #avatar{width:60px;height:60px}
  }
</style>

<!-- Video box -->
<div id="videoWrap" aria-label="clip">
  <iframe id="tw" allow="autoplay" title="Twitch Clip"></iframe>
</div>

<!-- GIF fallback (centered) -->
<div id="gifWrap"><img id="gif" alt=""></div>

<!-- Banner (moved into videoWrap when clip exists) -->
<div id="banner" class="fixed">
  <div id="avatar"></div>
  <div id="texts">
    <div id="name">Friend</div>
    <div id="tag">Check out Friend!</div>
  </div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const name     = (qs.get('name')    || 'Friend').trim();
  const profile  = (qs.get('profile') || '').trim();
  const clipSlug = (qs.get('clip')    || '').trim();       // Twitch clip slug
  const vol      = Math.max(0, Math.min(1, parseFloat(qs.get('vol')||'0.35')));
  const dur      = parseInt(qs.get('dur')||'0',10) || 0;   // ms (optional)
  const text     = (qs.get('text')    || `Check out ${name}!`).trim();
  const fallback = (qs.get('fallback')|| 'assets/so_fallback.gif').trim(); // put a gif in repo

  // banner text & avatar
  document.getElementById('name').textContent = name;
  document.getElementById('tag').textContent  = text;
  if (profile) document.getElementById('avatar').style.backgroundImage = `url("${profile}")`;

  const videoWrap = document.getElementById('videoWrap');
  const banner    = document.getElementById('banner');
  const tw        = document.getElementById('tw');
  const gifWrap   = document.getElementById('gifWrap');
  const gif       = document.getElementById('gif');

  // Helper: switch banner into video or fixed on screen
  function useBannerInVideo(){
    banner.classList.remove('fixed');
    banner.classList.add('inVideo');
    videoWrap.appendChild(banner);
  }
  function useBannerFixed(){
    banner.classList.remove('inVideo');
    banner.classList.add('fixed');
    document.body.appendChild(banner);
  }

  if (clipSlug){
    // Show video + move banner into it
    const parents = [location.hostname, 'localhost'];
    const p = parents.map(x => `parent=${encodeURIComponent(x)}`).join('&');
    const muted = (vol === 0) ? 'true' : 'false';

    tw.src = `https://clips.twitch.tv/embed?clip=${encodeURIComponent(clipSlug)}&autoplay=true&muted=${muted}&${p}`;
    videoWrap.style.display = 'block';
    useBannerInVideo();

    // If the embed doesn't load in time, fall back to GIF (center screen) + fixed banner
    let safety = setTimeout(() => {
      videoWrap.style.display = 'none';
      if (fallback){
        gif.src = fallback; gifWrap.style.display = 'flex';
        useBannerFixed();
      }
    }, 2500);
    tw.addEventListener('load', () => clearTimeout(safety));
  } else {
    // No clip â†’ show centered GIF (if provided) + fixed banner
    if (fallback){
      gif.src = fallback; gifWrap.style.display = 'flex';
    }
    useBannerFixed();
  }

  // Soft auto-fade if a duration is provided (OBS still hides via C#)
  if (dur > 0){
    setTimeout(() => {
      document.body.style.transition = 'opacity .25s ease';
      document.body.style.opacity = '0';
    }, dur);
  }
})();
</script>
