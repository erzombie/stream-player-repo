<!doctype html>
<meta charset="utf-8" />
<title>SO Player</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --radius: 16px;
    --bannerBg: rgba(36,36,36,.92);
    --bannerText: #fff;
    --muted: #cfd2d6;
  }
  html,body{margin:0;height:100%;background:transparent;overflow:hidden}

  /* Layout: media frame + bottom banner */
  #root{
    position:fixed; inset:0;
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    gap:20px; pointer-events:none;
  }

  /* 16:9 media frame (video/clip/gif) */
  #frame{
    position:relative;
    width:min(90vw, 1200px);
    aspect-ratio:16/9;
    border-radius:var(--radius);
    background:#0a0a0a;         /* becomes transparent in gif mode */
    box-shadow:0 10px 28px rgba(0,0,0,.35);
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  body.noVideo #frame{
    background:transparent;
    box-shadow:none;
  }

  /* Twitch embeds / GIF */
  iframe, #gif{
    position:absolute; inset:0; width:100%; height:100%; border:0;
    background:transparent;
  }
  /* Big, nice GIF */
  #gif{
    object-fit:contain;
    width:100%; height:100%;
    border-radius:var(--radius);
  }

  /* Bottom banner (always visible) */
  #banner{
    position:relative;
    width:min(78vw, 820px);
    border-radius:28px;
    background:var(--bannerBg);
    color:var(--bannerText);
    display:flex; align-items:center; gap:16px;
    padding:12px 20px;
    box-shadow:0 10px 24px rgba(0,0,0,.35);
  }
  #pfp{
    width:56px; height:56px; border-radius:50%; flex:0 0 56px;
    background:#1c1c1c center/cover no-repeat;
    box-shadow: inset 0 0 0 3px rgba(255,255,255,.06),
                0 2px 8px rgba(0,0,0,.35);
  }
  #txt{display:flex; flex-direction:column; line-height:1}
  #name{font:700 34px/1.1 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; letter-spacing:.5px}
  #sub {font:500 18px/1.2 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; color:var(--muted)}

  /* Small screens (or tiny sources in OBS) */
  @media (max-width: 680px){
    #name{font-size:26px}
    #sub {font-size:15px}
    #pfp{width:44px;height:44px;flex-basis:44px}
    #banner{padding:10px 16px}
  }
</style>

<div id="root">
  <div id="frame">
    <iframe id="clip" allow="autoplay" referrerpolicy="no-referrer"></iframe>
    <div id="twWrap"></div><!-- Twitch Player div (VOD/live) -->
    <img id="gif" alt="">
  </div>

  <div id="banner">
    <div id="pfp"></div>
    <div id="txt">
      <div id="name">Streamer</div>
      <div id="sub">Check out <span id="nm2">Streamer</span>!</div>
    </div>
  </div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const name    = qs.get('name')    || 'Friend';
  const pfp     = qs.get('profile') || '';
  const clipId  = qs.get('clip')    || '';
  const vodId   = qs.get('vod')     || '';          // new
  const vol     = Math.max(0, Math.min(1, parseFloat(qs.get('vol')||'0.35')));
  const parent  = location.hostname || 'localhost';
  const gifQS   = qs.get('gif') || '';              // optional override
  const gifList = qs.get('giflist') || 'assets/gifs/index.txt'; // list for randoms
  const fallbackGif = 'assets/hellothere.gif';

  // Banner text & avatar
  document.getElementById('name').textContent = name;
  document.getElementById('nm2').textContent  = name;
  if (pfp) document.getElementById('pfp').style.backgroundImage = `url("${pfp}")`;

  // Helpers
  const $ = sel => document.querySelector(sel);
  const show = id => { $('#clip').style.display='none'; $('#gif').style.display='none'; $('#twWrap').style.display='none'; $(id).style.display='block'; };

  // Prefer: VOD -> clip -> gif
  if (vodId){
    document.body.classList.remove('noVideo');
    // Twitch Player API
    const s = document.createElement('script');
    s.src = "https://player.twitch.tv/js/embed/v1.js";
    s.onload = () => {
      const div = document.createElement('div');
      div.id = "twPlayer";
      $('#twWrap').appendChild(div);
      show('#twWrap');
      const player = new Twitch.Player("twPlayer", {
        video: vodId,
        autoplay: true, muted: vol === 0, volume: vol,
        parent: [parent],
        controls: true
      });
      try { player.setVolume(vol); } catch {}
    };
    document.head.appendChild(s);
  } else if (clipId){
    document.body.classList.remove('noVideo');
    const url = `https://clips.twitch.tv/embed?clip=${encodeURIComponent(clipId)}&parent=${encodeURIComponent(parent)}&autoplay=true&muted=${vol===0?'true':'false'}`;
    $('#clip').src = url;
    show('#clip');
  } else {
    // GIF fallback (random if index exists)
    document.body.classList.add('noVideo');
    (async () => {
      let gif = gifQS;
      if (!gif){
        try{
          const r = await fetch(gifList, {cache:'no-store'});
          if (r.ok){
            const txt = await r.text();
            const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(s=>s && !s.startsWith('#'));
            if (lines.length) gif = lines[Math.floor(Math.random()*lines.length)];
          }
        }catch{}
      }
      if (!gif) gif = fallbackGif;
      $('#gif').src = gif;
      show('#gif');
    })();
  }
})();
</script>
