let bgSrc;
    if (cfg.theme==='down') {
      bgSrc = cfg.bgImageNeg || cfg.bgImage || DEFAULT_BG_DOWN;
    } else {
      bgSrc = cfg.bgImage || DEFAULT_BG_UP;
    }
    }
    }
    if (cfg.theme==='down') {
      bgSrc = cfg.bgImageNeg || cfg.bgImage || DEFAULT_BG_DOWN;
    } else {
      bgSrc = cfg.bgImage || DEFAULT_BG_UP;
    }<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Uma Stat Overlay</title>
  <style>
    :root{
      --textOrange:#ff8a00;
      --white:#ffffff;
      --strokeW:4px;    /* white outline width */
      --font:'Roboto',system-ui,-apple-system,'Segoe UI',Arial,sans-serif;
      --shadow:0 14px 40px rgba(0,0,0,.35);
      --tileW:260px; --tileH:180px; /* overridable via URL */
      --bgOpacity:0.68;            /* default bg image opacity */
      --upDist:150px;              /* travel distance for theme=up */
      --downDist:150px;            /* travel distance for theme=down */
    }
    html,body{margin:0;height:100%;background:transparent;overflow:hidden}
    #stage{position:relative;width:100vw;height:100vh;pointer-events:none}

    .popup{position:absolute;filter:drop-shadow(var(--shadow))}

    .tile{position:relative;width:var(--tileW);height:var(--tileH)}
    .tile img{position:absolute;left:50%;top:50%;width:100%;height:auto;transform:translate(-50%,-50%);opacity:var(--bgOpacity)}

    /* number on top, label below (like reference) */
    .num{position:absolute;left:0;right:0;top:18px;text-align:center;font:900 64px/1 var(--font);color:var(--textOrange);
         -webkit-text-stroke:var(--strokeW) var(--white)}

    .labelImg{position:absolute;left:50%;transform:translateX(-50%);bottom:12px;height:38px;object-fit:contain;pointer-events:none;filter:none}
    .icon{width:24px;height:24px;display:inline-block}

    @keyframes riseFade{0%{transform:translateY(0) scale(.96);opacity:0}8%{opacity:1}70%{transform:translateY(calc(var(--upDist)*-0.6)) scale(1.02);opacity:1}100%{transform:translateY(calc(var(--upDist)*-1)) scale(1);opacity:0}}
    .animUp{animation:riseFade var(--dur,1600ms) cubic-bezier(.2,.9,.2,1) forwards}

    @keyframes dropFade{0%{transform:translateY(0) scale(.96);opacity:0}8%{opacity:1}70%{transform:translateY(calc(var(--downDist))) scale(1.02);opacity:1}100%{transform:translateY(calc(var(--downDist) + 60px)) scale(1);opacity:0}}
    .animDown{animation:dropFade var(--dur,1600ms) cubic-bezier(.2,.9,.2,1) forwards}
  </style>
</head>
<body>
  <div id="stage"></div>
  <audio id="sfx" preload="auto"></audio>

  <script>
  // Default background image hard-coded to your GitHub PNG, override with &bgImage=
  const DEFAULT_BG_UP = 'https://erzombie.github.io/stream-player-repo/uma_overlay/uma_pos_chevron.png';
  const DEFAULT_BG_DOWN = 'https://erzombie.github.io/stream-player-repo/uma_overlay/uma_neg_chevron.png';
  const DEFAULT_SFX_UP = 'https://erzombie.github.io/stream-player-repo/uma_overlay/uma_pos.ogg';
  const DEFAULT_SFX_DOWN = 'https://erzombie.github.io/stream-player-repo/uma_overlay/uma_neg.ogg';
  // Fallback alias to catch any older references
  const DEFAULT_BG = DEFAULT_BG_UP; // <-- replace with your real file

  const qs=new URLSearchParams(location.search);
  const STAT_POOL=['Speed','Stamina','Power','Guts','Wit'];
  const cfg={
    mode:qs.get('mode')||'',
    stat:qs.get('stat')||'Wit',
    amount:qs.has('amount')?parseInt(qs.get('amount')||'1',10):null,
    count:Math.max(1,Math.min(5,parseInt(qs.get('count')||'1',10))),
    concurrent:Math.max(1,Math.min(2,parseInt(qs.get('concurrent')||'2',10))),
    dur:parseInt(qs.get('dur')||'1600',10),
    sound:qs.get('sound')||DEFAULT_SFX_UP,
    soundDown:qs.get('soundDown')||qs.get('soundNeg')||DEFAULT_SFX_DOWN,
    minDelay:parseInt(qs.get('minDelay')||'60',10),
    maxDelay:parseInt(qs.get('maxDelay')||'180',10),
    bgImage:qs.get('bgImage')||'',
    bgImageNeg:qs.get('bgImageNeg')||'',
    theme:(qs.get('theme')||'up').toLowerCase(), // 'up' | 'down'
    tileW:parseInt(qs.get('tileW')||'260',10),
    tileH:parseInt(qs.get('tileH')||'180',10),
    bgOpacity:parseFloat(qs.get('bgOpacity')||'0.68')
  };
  document.documentElement.style.setProperty('--tileW', cfg.tileW+'px');
  document.documentElement.style.setProperty('--tileH', cfg.tileH+'px');
  document.documentElement.style.setProperty('--bgOpacity', String(Math.max(0, Math.min(1, cfg.bgOpacity))));

  switch(cfg.mode){
    case'v1_wit5':cfg.stat='Wit';cfg.amount=1;cfg.count=5;cfg.concurrent=2;break;
    case'v2_guts5':cfg.stat='Guts';cfg.amount=1;cfg.count=5;cfg.concurrent=2;break;
    case'v3_wit1':cfg.stat='Wit';cfg.amount=1;cfg.count=1;cfg.concurrent=1;break;
    case'v4_random':cfg.count=Math.floor(Math.random()*5)+1;cfg.concurrent=2;break;
  }

  const stage=document.getElementById('stage');
  const sfxEl=document.getElementById('sfx');
  const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a; const choice=a=>a[Math.floor(Math.random()*a.length)];

  // Hard-coded mapping to PNG labels instead of SVG icons
  const STAT_LABELS = {
    Speed: "https://erzombie.github.io/stream-player-repo/uma_overlay/label_speed.png",
    Stamina: "https://erzombie.github.io/stream-player-repo/uma_overlay/label_stamina.png",
    Power: "https://erzombie.github.io/stream-player-repo/uma_overlay/label_power.png",
    Guts: "https://erzombie.github.io/stream-player-repo/uma_overlay/label_guts.png",
    Wit: "https://erzombie.github.io/stream-player-repo/uma_overlay/label_wit.png"
  }

  function spawnOne({stat,amount,dur}){
    const wrap=document.createElement('div');wrap.className='popup ' + (cfg.theme==='down' ? 'animDown' : 'animUp');wrap.style.setProperty('--dur',`${dur}ms`);
    const margin=140;const x=rand(margin,window.innerWidth-margin-cfg.tileW);const y=rand(margin,window.innerHeight-margin-cfg.tileH);
    wrap.style.left=x+'px';wrap.style.top=y+'px';

    const tile=document.createElement('div');tile.className='tile';

    // Choose background depending on theme
    let bgSrc;
    if (cfg.theme==='down') {
      bgSrc = cfg.bgImageNeg || cfg.bgImage || DEFAULT_BG_DOWN;
    } else {
      bgSrc = cfg.bgImage || DEFAULT_BG_UP;
    }
    }
    if (cfg.theme==='down') bgSrc = cfg.bgImageNeg || cfg.bgImage || DEFAULT_BG;
    const img=document.createElement('img'); img.src=bgSrc; tile.appendChild(img);

    const num=document.createElement('div');num.className='num';
    const prefix = (cfg.theme==='down' && String(amount)[0]!== '-') ? '-' : '+';
    num.textContent=`${prefix}${Math.abs(amount)}`;

    const labelImg=document.createElement('img');
    labelImg.className='labelImg';
    labelImg.src = (typeof STAT_LABELS!== 'undefined' && STAT_LABELS[stat]) ? STAT_LABELS[stat] : '';
    tile.appendChild(labelImg);wrap.appendChild(tile);stage.appendChild(wrap);

    const sfxToPlay = (cfg.theme==='down' && cfg.soundDown) ? cfg.soundDown : cfg.sound;
    if(sfxToPlay){ try{ if(sfxEl.src!==sfxToPlay) sfxEl.src=sfxToPlay; sfxEl.currentTime=0; sfxEl.play().catch(()=>{});}catch(e){} }

    setTimeout(()=>wrap.remove(),dur+120);
  }

  async function batchSpawn(){
    const total=cfg.count;const fixed=cfg.amount??null;const jobs=[];
    for(let i=0;i<total;i++)jobs.push({stat:(cfg.mode==='v4_random')?STAT_POOL[Math.floor(Math.random()*STAT_POOL.length)]:cfg.stat,amount:(fixed==null&&cfg.mode==='v4_random')?rand(1,20):(fixed??1),delay:rand(cfg.minDelay,cfg.maxDelay)});
    let inFlight=0,idx=0;return new Promise(res=>{function go(){while(inFlight<cfg.concurrent&&idx<jobs.length){const j=jobs[idx++];inFlight++;setTimeout(()=>{spawnOne({stat:j.stat,amount:j.amount,dur:cfg.dur});setTimeout(()=>{inFlight--;go();if(idx===jobs.length&&inFlight===0)res()},cfg.dur+150)},j.delay)} } go()});
  }

  (async()=>{await batchSpawn()})();
  </script>
</body>
</html>
